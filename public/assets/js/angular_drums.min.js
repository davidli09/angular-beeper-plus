"use strict";var app=angular.module("AngularDrumMachine",[]);app.controller("DrumMachineCtrl",function($scope,drumMachine){drumMachine.loadInstruments(),drumMachine.loadSequence(),$scope.machine=drumMachine,$scope.playLoop=function(){$scope.machine.play(),$scope.fade_msg_play=!0},$scope.stopLoop=function(){$scope.machine.stop()},$scope.resetLoop=function(){$scope.machine.reset()},$scope.updateTempo=function(){$scope.machine.setTempo($scope.machine.tempo)}}),app.filter("range",function(){return function(input,total){total=parseInt(total);for(var i=0;total>i;i++)input.push(i);return input}}),app.factory("drumMachine",function($http,timerQueue){function loadInstruments(instrumentFile){var item,player,instrument,file=instrumentFile||"/app/services/data/instruments/kit-1.json";$http.get(file).success(function(data){for(var i=0;4>i;i++)item=data.instruments[i],player=new Howl({urls:["assets/audio/"+item.file]}),instrument=new Instrument(player,item),_rows.push(new Row(instrument,gridLength))}),_delay=beatDelay()}function loadSequence(sequenceFile){var file=sequenceFile||"/app/services/data/sequences/seq-1.json";stop(),$http.get(file).success(function(data){console.log(data),gridLength=data.gridLength,tempo=data.tempo;for(var i=0;4>i;i++)for(var j=0;gridLength>j;j++)"1"===data.rows[i][j]?_rows[i].getBeats()[j].activate():_rows[i].getBeats()[j].deactivate()})}function rows(){return _rows}function setTempo(newTempo){tempo=newTempo,_delay=beatDelay()}function currentBeat(){return _currentBeat}function play(){_playing=!0,_timers.add(playBeat(),beatDelay())}function stop(){_playing=!1,_timers.clear()}function reset(){stop(),_currentBeat=0,resetAllRows()}function playBeat(){return function(){_currentBeat>=gridLength&&(_currentBeat=0);for(var i=0;i<_rows.length;i++)_rows[i].playSound(_currentBeat);_currentBeat+=1,_timers.add(playBeat(),_delay)}}function resetAllRows(){for(var i=0;i<_rows.length;i++)_rows[i].reset()}function beatDelay(){return 1e3/(tempo*(gridLength/timeSignature))*60}var _playing=!1,_currentBeat=0,_delay=100,_timers=timerQueue,_rows=[],timeSignature=4,gridLength=8,tempo=120;return{loadInstruments:loadInstruments,loadSequence:loadSequence,gridLength:gridLength,timeSignature:timeSignature,currentBeat:currentBeat,rows:rows,tempo:tempo,setTempo:setTempo,play:play,stop:stop,reset:reset}});var Beat=function(){function isActive(){return active}function activate(){active=!0}function deactivate(){active=!1}function toggle(){active=active?!1:!0}var active=!1;return{isActive:isActive,activate:activate,deactivate:deactivate,toggle:toggle}},Instrument=function(player,inst){function getName(){return name}function getDescription(){return description}function play(){try{return audioPlayer.play(),!0}catch(e){return console.log("Unable to play sound",e),!1}}var audioPlayer=player,name=inst.name,description=inst.description;return{getName:getName,getDescription:getDescription,play:play}},Row=function(instrument,initialBeats){function getInstrument(){return instrument}function getBeats(){return beats}function addBeats(num){for(var i=0;num>i;i++)beats.push(new Beat)}function reset(){for(var i=0;i<beats.length;i++)beats[i].deactivate()}function playSound(index){return beats[index].isActive()?instrument.play():!1}var instrument=instrument,beats=[];return addBeats(initialBeats),{getInstrument:getInstrument,getBeats:getBeats,addBeats:addBeats,reset:reset,playSound:playSound}};app.factory("timerQueue",function($timeout){function queue(){return _queue}function add(fn,delay){_queue.push($timeout(fn,delay))}function clear(){for(var i=0;i<_queue.length;i++)$timeout.cancel(_queue[i]);_queue=[]}var _queue=new Array;return{queue:queue,add:add,clear:clear}});